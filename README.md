# bCNC_Pendant
Hand pulse generator for bCNC with USB interface

## Description
This is Hand Pulse Generator(HPG) for bCNC using STM32F401 Developping board.

![HPG with bCNC](https://raw.github.com/wiki/ekqxa6/bCNC_Pendant/appearance.jpg)

bCNC has a keyboard shortcut for JOG operation. This HPG is sending key code for JOG using USB-HID.
[Link](https://github.com/vlachoudis/bCNC/wiki/Jogging)

Additionally bCNC has short-cuts for Cycle resume and Feed Hold. Those are very useful for a first cut.


## Circuit schematic

![Schematic](https://raw.github.com/wiki/ekqxa6/bCNC_Pendant/drawing.png)

OLED is connected to I2C 1 (PB8 and PB9)
Rotary encoder is connected to TIM4 (PB7 and PB8)
Ports for Switchs and rotary encoder phase A and B are pull-up setting.

## Usage
Connect to PC via USB inerface.
Make sure MDI command line is not active. (If active press "ESC" key).
Select Axis using Axis Up or Down and step size. Step size is availabe 1mm/step, 0.1mm/set, 0.01mm/step, 0.001/step.
Key code is out when dial the encoder.

Display showing the remaning pulses. If you generated too much pulses, you can reduce by counterrotating of the encoder. Changing axis or stpe size cancel the remaning pulse.

## Note
USB-HID is generated by STM32CubeMX. This template is for mouse control and keyboard control is not available.
I modified HID library. **This modification will be overwriten (deleted) when generating code by STM32CubeMX.**

usbd_hid.h

```
#define HID_EPIN_SIZE                              0x05U // original is 0.04U
#define HID_MOUSE_REPORT_DESC_SIZE                 78U // original is 74U
```

usbd_hid.c
Replaced HID_MOUSE_ReportDesc with below coding.

```
__ALIGN_BEGIN static uint8_t HID_MOUSE_ReportDesc[HID_MOUSE_REPORT_DESC_SIZE] __ALIGN_END = {
		// 78 bytes
		0x05, 0x01, // Usage Page (Generic Desktop Ctrls)
		0x09, 0x06, // Usage (Keyboard)
		0xA1, 0x01, // Collection (Application)
		0x85, 0x01, // Report ID (1)
		0x05, 0x07, // Usage Page (Kbrd/Keypad)
		0x75, 0x01, // Report Size (1)
		0x95, 0x08, // Report Count (8)
		0x19, 0xE0, // Usage Minimum (0xE0)
		0x29, 0xE7, // Usage Maximum (0xE7)
		0x15, 0x00, // Logical Minimum (0)
		0x25, 0x01, // Logical Maximum (1)
		0x81, 0x02, // Input (Data,Var,Abs,No Wrap,Linear,Preferred State,No Null Position)
		0x95, 0x03, // Report Count (3)
		0x75, 0x08, // Report Size (8)
		0x15, 0x00, // Logical Minimum (0)
		0x25, 0x64, // Logical Maximum (100)
		0x05, 0x07, // Usage Page (Kbrd/Keypad)
		0x19, 0x00, // Usage Minimum (0x00)
		0x29, 0x65, // Usage Maximum (0x65)
		0x81, 0x00, // Input (Data,Array,Abs,No Wrap,Linear,Preferred State,No Null Position)
		0xC0, // End Collection
		0x05, 0x0C, // Usage Page (Consumer)
		0x09, 0x01, // Usage (Consumer Control)
		0xA1, 0x01, // Collection (Application)
		0x85, 0x02, // Report ID (2)
		0x05, 0x0C, // Usage Page (Consumer)
		0x15, 0x00, // Logical Minimum (0)
		0x25, 0x01, // Logical Maximum (1)
		0x75, 0x01, // Report Size (1)
		0x95, 0x08, // Report Count (8)
		0x09, 0xB5, // Usage (Scan Next Track)
		0x09, 0xB6, // Usage (Scan Previous Track)
		0x09, 0xB7, // Usage (Stop)
		0x09, 0xB8, // Usage (Eject)
		0x09, 0xCD, // Usage (Play/Pause)
		0x09, 0xE2, // Usage (Mute)
		0x09, 0xE9, // Usage (Volume Increment)
		0x09, 0xEA, // Usage (Volume Decrement)
		0x81, 0x02, // Input (Data,Var,Abs,No Wrap,Linear,Preferred State,No Null Position)
		0xC0, // End Collection
};
```

